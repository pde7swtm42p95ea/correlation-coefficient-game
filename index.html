<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š ç›¸é–¢ä¿‚æ•° å½“ã¦ã‚²ãƒ¼ãƒ </title>
<style>
body {
  font-family: 'Hiragino Kaku Gothic ProN', 'Segoe UI', sans-serif;
  text-align: center;
  margin: 10px;
  background: #fafafa;
}
canvas {
  border: 1px solid #ccc;
  width: 90vw;
  max-width: 360px;
  height: auto;
  background: white;
  margin: 10px auto;
  display: block;
}
button {
  margin: 8px;
  padding: 10px 15px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #f0f0f0;
}
button:hover { background: #e0e0e0; }
#result {
  font-weight: bold;
  margin-top: 10px;
  font-size: 18px;
  transition: color 0.3s ease;
}
#score {
  font-size: 16px;
  margin: 5px 0;
}
#hearts {
  font-size: 24px;
  margin-top: 5px;
}
.choice-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  margin: 10px 0;
}
.choice-container label {
  margin: 5px 10px;
  font-size: 16px;
  cursor: pointer;
}
input[type="radio"] { margin-right: 5px; }
</style>
</head>
<body>
<h2>ğŸ“Š ç›¸é–¢ä¿‚æ•° å½“ã¦ã‚²ãƒ¼ãƒ </h2>
<p>æ•£å¸ƒå›³ã‚’è¦‹ã¦ã€æ­£ç¢ºãªç›¸é–¢ä¿‚æ•°ã‚’é¸ã¼ã†ï¼</p>
<div id="score">ãƒ¬ãƒ™ãƒ«: 1ã€€åˆè¨ˆæ­£è§£: 0</div>
<div id="hearts">ğŸ’–ğŸ’–ğŸ’–</div>
<canvas id="scatter" width="360" height="360"></canvas>
<div class="choice-container" id="choices"></div>
<button id="checkBtn" onclick="checkAnswer()">ç­”ãˆåˆã‚ã›</button>
<p id="result"></p>
<button onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸</button>

<script>
let trueR = 0;
let points = [];
let totalCorrect = 0;
let wrongCount = 0;
let answered = false;
let level = 1;
const maxMistakes = 3;

function randn() {
  let u=0,v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random();
  return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
}

function getStdDevByLevel(lv){
  if(lv===1) return 0.6;
  if(lv===2) return 0.8;
  if(lv===3) return 1.5;
  return 2.0;
}

function getColorByLevel(lv){
  if(lv===1) return "steelblue";
  if(lv===2) return "orange";
  if(lv===3) return "green";
  return "crimson";
}

function generateData(r,n=80,lv=1){
  const data=[];
  const sd=getStdDevByLevel(lv);
  for(let i=0;i<n;i++){
    const x=randn()*sd;
    const y=r*x + Math.sqrt(1-r*r)*randn()*sd;
    data.push([x,y]);
  }
  return data;
}

function drawScatter(data){
  const ctx=document.getElementById("scatter").getContext("2d");
  ctx.clearRect(0,0,360,360);
  ctx.fillStyle=getColorByLevel(level);
  data.forEach(([x,y])=>{
    const px=180+x*70;
    const py=180-y*70;
    ctx.beginPath();
    ctx.arc(px,py,3,0,2*Math.PI);
    ctx.fill();
  });
}

function generateDistinctValues(center,count,min,max){
  const values=[];
  let attempts=0;
  while(values.length<count && attempts<500){
    const val=min+(max-min)*Math.random();
    const rounded=Math.round(val*100)/100;
    if(values.every(x=>Math.abs(x-rounded)>=0.15)){
      values.push(rounded);
    }
    attempts++;
  }
  return values;
}

function newQuestion(){
  document.getElementById("result").textContent="";
  document.getElementById("result").style.color="#000";
  answered=false;

  level = Math.floor(totalCorrect/5)+1;
  trueR = Math.round((Math.random()*2-1)*100)/100;
  points = generateData(trueR,100,level);
  drawScatter(points);

  // 3 positive + 3 negative choices
  const positive = generateDistinctValues(0.5,3,0,1);
  const negative = generateDistinctValues(-0.5,3,-1,0);
  let choices = [...positive, ...negative];

  // Insert true answer randomly
  if(!choices.includes(trueR)) {
    const idx = Math.floor(Math.random()*choices.length);
    choices[idx] = trueR;
  }

  // Ensure spacing â‰¥ 0.15
  choices = [...new Set(choices)].sort((a,b)=>a-b);
  for(let i=0;i<choices.length;i++){
    for(let j=i+1;j<choices.length;j++){
      if(Math.abs(choices[i]-choices[j])<0.15){
        choices[j]=choices[j]>0?choices[j]+0.15:choices[j]-0.15;
      }
    }
  }

  const container=document.getElementById("choices");
  container.innerHTML="";
  choices.forEach((c,i)=>{
    const label=document.createElement("label");
    label.innerHTML=`<input type="radio" name="rchoice" value="${c}" ${i===0?"checked":""}>${c.toFixed(2)}`;
    container.appendChild(label);
  });

  setRadioDisabled(false);
  updateScoreDisplay();
}

function setRadioDisabled(disabled){
  document.querySelectorAll('input[name="rchoice"]').forEach(input=>{
    input.disabled=disabled;
  });
}

function checkAnswer(){
  if(answered) return;
  answered=true;
  const selected=parseFloat(document.querySelector('input[name="rchoice"]:checked').value);

  const resultEl=document.getElementById("result");

  if(selected===trueR){
    totalCorrect++;
    resultEl.textContent=`ğŸ¯ æ­£è§£ï¼ å®Ÿéš›ã®ç›¸é–¢ä¿‚æ•°ã¯ ${trueR.toFixed(2)}`;
    resultEl.style.color="#007bff";
  } else {
    wrongCount++;
    resultEl.textContent=`âŒ æ®‹å¿µï¼ æ­£è§£ã¯ ${trueR.toFixed(2)} ã§ã—ãŸã€‚`;
    resultEl.style.color="#ff3333";
  }

  if(wrongCount>=maxMistakes){
    resultEl.innerHTML=`ğŸ’€ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼<br>æœ€çµ‚ã‚¹ã‚³ã‚¢: ${totalCorrect}`;
    resultEl.style.color="#ff3333";
  }

  setRadioDisabled(true);
  updateScoreDisplay();
}

function nextQuestion(){
  if(wrongCount>=maxMistakes){
    totalCorrect=0;
    wrongCount=0;
  }
  newQuestion();
}

function updateScoreDisplay(){
  document.getElementById("score").textContent=`ãƒ¬ãƒ™ãƒ«: ${level}ã€€åˆè¨ˆæ­£è§£: ${totalCorrect}`;
  const hearts = "ğŸ’–".repeat(maxMistakes - wrongCount) + "ğŸ’”".repeat(wrongCount);
  document.getElementById("hearts").textContent = hearts;
}

newQuestion();
</script>
</body>
</html>
