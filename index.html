<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“Š ç›¸é–¢ä¿‚æ•° å½“ã¦ã‚²ãƒ¼ãƒ </title>
<style>
:root {
  --bg:#fafafa; --border:#ccc;
  --ok:#007bff; --ng:#ff3333;
  --btn-check:#007bff; --btn-next:#28a745;
}
html,body{height:100%; margin:0; background:var(--bg); font-family:'Hiragino Kaku Gothic ProN','Segoe UI',sans-serif;}
.container{max-width:860px; margin:0 auto; padding:12px; text-align:center;}
h2{margin:8px 0; font-size:clamp(1.1rem,2.2vw,1.6rem);}
p{margin:6px 0;}
#score{margin:6px 0; font-size:0.98rem;}
.canvas-wrap{display:flex; justify-content:center; margin:8px 0;}
canvas{width:92vw; max-width:420px; aspect-ratio:1/1; background:#fff; border:1px solid var(--border); border-radius:10px;}
.choice-container{display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin:10px 0;}
.choice-container label{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; background:#fff; border:1px solid #e6e6e6; cursor:pointer;}
input[type="radio"]{transform:scale(1.15);}
#result{font-weight:700; margin-top:10px; min-height:2.4em; transition:color .25s;}
#hearts{font-size:22px; margin-top:6px;}

/* ãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ */
.btn-row{display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin-top:12px;}
.btn{
  padding:10px 14px; border-radius:8px; border:1px solid var(--border);
  font-size:1rem; color:#fff; cursor:pointer;
  flex:1 1 140px; max-width:200px;
  transition:transform .25s,opacity .25s;
}
#checkBtn{background:var(--btn-check);}
#nextBtn{background:var(--btn-next);}
.btn:hover{opacity:0.85;}
@media(max-width:480px){
  .btn-row{flex-direction:column; gap:8px;}
  #result{margin-bottom:60px;}
}

/* ãƒ•ãƒƒã‚¿ãƒ¼ */
footer{
  position:sticky; bottom:0; background:var(--bg);
  padding:10px 0; border-top:1px solid var(--border);
  display:flex; justify-content:center;
}
footer .btn-row{width:100%; max-width:420px;}

/* âœ¨å…‰ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes flashBlue {
  0%{box-shadow:0 0 0px rgba(0,123,255,0);}
  50%{box-shadow:0 0 20px rgba(0,123,255,0.8);}
  100%{box-shadow:0 0 0px rgba(0,123,255,0);}
}
@keyframes flashRed {
  0%{box-shadow:0 0 0px rgba(255,51,51,0);}
  50%{box-shadow:0 0 20px rgba(255,51,51,0.8);}
  100%{box-shadow:0 0 0px rgba(255,51,51,0);}
}
.flash-blue{animation:flashBlue 0.8s ease;}
.flash-red{animation:flashRed 0.8s ease;}
</style>
</head>
<body>
<div class="container">
  <h2>ğŸ“Š ç›¸é–¢ä¿‚æ•° å½“ã¦ã‚²ãƒ¼ãƒ </h2>
  <p>æ•£å¸ƒå›³ã‚’è¦‹ã¦ã€6ã¤ã‹ã‚‰ç›¸é–¢ä¿‚æ•°ã‚’å½“ã¦ã‚ˆã†ï¼</p>
  <div id="score">ãƒ¬ãƒ™ãƒ«: 1ã€€åˆè¨ˆæ­£è§£: 0</div>
  <div id="hearts">ğŸ’–ğŸ’–ğŸ’–</div>

  <div class="canvas-wrap"><canvas id="scatter" width="360" height="360"></canvas></div>
  <div class="choice-container" id="choices"></div>
  <p id="result"></p>
</div>

<footer>
  <div class="btn-row">
    <button class="btn" id="checkBtn">ç­”ãˆåˆã‚ã›</button>
    <button class="btn" id="nextBtn">æ¬¡ã®å•é¡Œã¸</button>
  </div>
</footer>

<script>
let trueR=0,points=[],totalCorrect=0,wrongCount=0,answered=false,level=1;
const maxMistakes=3;
function randn(){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);}
function clamp(v,min,max){return Math.min(Math.max(v,min),max);}
function to2(v){return Number(Number(v).toFixed(2));}
function getStdDevByLevel(lv){return lv===1?0.6:lv===2?0.8:lv===3?1.5:2.0;}
function getColorByLevel(lv){return lv===1?"steelblue":lv===2?"orange":lv===3?"green":"crimson";}
function generateData(r,n=100,lv=1){
  const d=[],sd=getStdDevByLevel(lv),safeR=clamp(r,-0.9999,0.9999);
  for(let i=0;i<n;i++){const x=randn()*sd, y=safeR*x+Math.sqrt(1-safeR*safeR)*randn()*sd;d.push([x,y]);}
  return d;
}
function drawScatter(data){
  const c=document.getElementById('scatter'),ctx=c.getContext('2d');
  const dpr=window.devicePixelRatio||1,cssSize=Math.min(window.innerWidth*0.92,420);
  c.style.width=cssSize+'px';c.style.height=cssSize+'px';
  c.width=Math.round(cssSize*dpr);c.height=Math.round(cssSize*dpr);
  ctx.scale(dpr,dpr);ctx.clearRect(0,0,cssSize,cssSize);
  ctx.fillStyle=getColorByLevel(level);
  const center=cssSize/2,scale=cssSize/5;
  data.forEach(([x,y])=>{
    const px=center+x*scale,py=center-y*scale;
    ctx.beginPath();ctx.arc(px,py,3,0,Math.PI*2);ctx.fill();
  });
}
function createChoicesStrict(trueR){
  const minDiff=0.15;
  const group=(cnt,min,max,avoid=[])=>{
    const arr=[];let tries=0;
    while(arr.length<cnt && tries<500){
      const v=to2(min+Math.random()*(max-min));
      if([...arr,...avoid].every(a=>Math.abs(a-v)>=minDiff))arr.push(v);
      tries++;
    }return arr;
  };
  let pos,neg;
  if(trueR>=0){
    pos=group(3,0.15,1,[trueR]);
    pos[Math.floor(Math.random()*3)]=trueR;
    neg=group(3,-1,-0.15,pos);
  }else{
    neg=group(3,-1,-0.15,[trueR]);
    neg[Math.floor(Math.random()*3)]=trueR;
    pos=group(3,0.15,1,neg);
  }
  return [...neg,...pos].sort((a,b)=>a-b);
}
function updateScore(){
  document.getElementById('score').textContent=`ãƒ¬ãƒ™ãƒ«: ${level}ã€€åˆè¨ˆæ­£è§£: ${totalCorrect}`;
  const hearts='ğŸ’–'.repeat(maxMistakes-wrongCount)+'ğŸ’”'.repeat(wrongCount);
  document.getElementById('hearts').textContent=hearts;
}
function disableChoices(dis){
  document.querySelectorAll('input[name="rchoice"]').forEach(i=>i.disabled=dis);
}
function newQuestion(){
  answered=false;
  const res=document.getElementById('result');
  res.textContent='';res.style.color='#000';
  level=Math.floor(totalCorrect/5)+1;
  trueR=to2(Math.random()*2-1);
  points=generateData(trueR,100,level);
  drawScatter(points);
  const ch=createChoicesStrict(trueR),c=document.getElementById('choices');
  c.innerHTML='';
  ch.forEach(v=>{
    const label=document.createElement('label');
    label.innerHTML=`<input type="radio" name="rchoice" value="${v}"> ${v.toFixed(2)}`;
    c.appendChild(label);
  });
  disableChoices(false); updateScore();
}
function checkAnswer(){
  if(answered)return;
  const sel=document.querySelector('input[name="rchoice"]:checked');
  if(!sel){alert('é¸æŠè‚¢ã‚’é¸ã‚“ã§ãã ã•ã„ï¼');return;}
  answered=true;
  const v=parseFloat(sel.value),res=document.getElementById('result');
  const btn=document.getElementById('checkBtn');
  btn.classList.remove('flash-blue','flash-red'); // reset animation
  void btn.offsetWidth; // reflow to restart animation
  if(Math.abs(v-trueR)<0.001){
    totalCorrect++; res.textContent=`ğŸ¯ æ­£è§£ï¼ å®Ÿéš›ã®ç›¸é–¢ä¿‚æ•°ã¯ ${trueR.toFixed(2)}`;
    res.style.color='var(--ok)';
    btn.classList.add('flash-blue');
  }else{
    wrongCount++; res.textContent=`âŒ æ®‹å¿µï¼ æ­£è§£ã¯ ${trueR.toFixed(2)} ã§ã—ãŸã€‚`;
    res.style.color='var(--ng)';
    btn.classList.add('flash-red');
    if(wrongCount>=maxMistakes){
      res.innerHTML=`ğŸ’€ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼!<br>æœ€çµ‚ã‚¹ã‚³ã‚¢: ${totalCorrect}`;
    }
  }
  disableChoices(true); updateScore();
}
function nextQuestion(){
  if(wrongCount>=maxMistakes){totalCorrect=0;wrongCount=0;}
  newQuestion();
}
document.getElementById('checkBtn').onclick=checkAnswer;
document.getElementById('nextBtn').onclick=nextQuestion;
window.onresize=()=>drawScatter(points);
newQuestion();
</script>
</body>
</html>
