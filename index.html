<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“Š ç›¸é–¢ä¿‚æ•°å½“ã¦ã‚²ãƒ¼ãƒ </title>
<style>
:root{
  --bg:#fafafa; --border:#ccc; --btn:#f0f0f0; --btn-hover:#e0e0e0;
}
body{margin:0; background:var(--bg); font-family:'Hiragino Kaku Gothic ProN','Segoe UI',sans-serif; text-align:center;}
h2{margin:12px 0; font-size:clamp(1.1rem,2vw,1.5rem);}
p{margin:6px 0; font-size:clamp(0.9rem,1.8vw,1rem);}
#score{font-size:clamp(0.9rem,1.6vw,1rem); margin-bottom:8px;}
canvas{
  width:95vw; max-width:420px; aspect-ratio:1/1;
  border:1px solid var(--border); border-radius:8px;
  background:#fff; display:block; margin:10px auto;
}
.choice-container{
  display:flex; flex-wrap:wrap; justify-content:center; gap:8px; margin:10px 0;
}
.choice-container label{
  display:flex; align-items:center; gap:6px;
  background:#fff; border:1px solid var(--border); border-radius:8px;
  padding:6px 10px; font-size:clamp(0.95rem,1.8vw,1rem); cursor:pointer;
}
input[type="radio"]{transform:scale(1.15);}
.btn{
  padding:10px 16px; margin:8px; border-radius:8px;
  border:1px solid var(--border); background:var(--btn);
  font-size:clamp(1rem,2vw,1.05rem); cursor:pointer;
}
.btn:hover{background:var(--btn-hover);}
#result{font-weight:700; margin-top:10px; font-size:clamp(1rem,2vw,1.1rem);}
</style>
</head>
<body>
<h2>ğŸ“Š ç›¸é–¢ä¿‚æ•°å½“ã¦ã‚²ãƒ¼ãƒ </h2>
<p>æ•£å¸ƒå›³ã‚’è¦‹ã¦ã€å¯¾å¿œã™ã‚‹ç›¸é–¢ä¿‚æ•°ã‚’é¸ã‚“ã§ã­ï¼</p>
<div id="score">ãƒ¬ãƒ™ãƒ«: 1  åˆè¨ˆæ­£è§£: 0  é–“é•ã„: 0/3</div>
<canvas id="scatter" width="360" height="360"></canvas>
<div class="choice-container" id="choices"></div>
<button class="btn" id="checkBtn">ç­”ãˆåˆã‚ã›</button>
<p id="result"></p>
<button class="btn" id="nextBtn">æ¬¡ã®å•é¡Œã¸</button>

<script>
let trueR=0, points=[], totalCorrect=0, wrongCount=0, answered=false, level=1;

function randn(){
  let u=0,v=0; while(u===0)u=Math.random(); while(v===0)v=Math.random();
  return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
}
function clamp(v,min,max){return Math.min(Math.max(v,min),max);}
function to2(v){return Number(v.toFixed(2));}

function getStdDevByLevel(lv){return lv===1?0.6:lv===2?0.8:lv===3?1.5:2.0;}
function getColorByLevel(lv){return lv===1?"steelblue":lv===2?"orange":lv===3?"green":"crimson";}

function generateData(r,n=80,lv=1){
  const data=[],sd=getStdDevByLevel(lv),safeR=clamp(r,-0.9999,0.9999);
  for(let i=0;i<n;i++){
    const x=randn()*sd;
    const y=safeR*x+Math.sqrt(1-safeR*safeR)*randn()*sd;
    data.push([x,y]);
  }
  return data;
}

function drawScatter(data){
  const canvas=document.getElementById("scatter");
  const ctx=canvas.getContext("2d");
  const dpr=window.devicePixelRatio||1;
  const cssSize=Math.min(window.innerWidth*0.9,420);
  canvas.style.width=cssSize+"px";
  canvas.style.height=cssSize+"px";
  canvas.width=cssSize*dpr;
  canvas.height=cssSize*dpr;
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,cssSize,cssSize);
  ctx.fillStyle=getColorByLevel(level);
  const center=cssSize/2, scaleFactor=cssSize/5;
  data.forEach(([x,y])=>{
    const px=center+x*scaleFactor, py=center-y*scaleFactor;
    ctx.beginPath(); ctx.arc(px,py,3,0,2*Math.PI); ctx.fill();
  });
}

/* ğŸ¯ 6æŠç”Ÿæˆï¼šæ­£3ãƒ»è² 3ãƒ»å…¨ä½“ã§0.15ä»¥ä¸Šå·®ã‚’ä¿è¨¼ */
function createChoices(trueR){
  const minDiff=0.15;
  let choices=[], attempts=0;
  while(attempts<500){
    const pos=[],neg=[];
    while(pos.length<3){
      const r=to2(0.05+Math.random()*0.95);
      if(pos.every(x=>Math.abs(x-r)>=minDiff)) pos.push(r);
    }
    while(neg.length<3){
      const r=to2(-0.05-Math.random()*0.95);
      if(neg.every(x=>Math.abs(x-r)>=minDiff)) neg.push(r);
    }
    choices=[...neg,...pos];

    // trueRã‚’ç½®æ›ï¼ˆåŒå´ã®ãƒ©ãƒ³ãƒ€ãƒ ä½ç½®ï¼‰
    if(trueR>=0){
      const idx=3+Math.floor(Math.random()*3);
      choices[idx]=to2(trueR);
    }else{
      const idx=Math.floor(Math.random()*3);
      choices[idx]=to2(trueR);
    }

    // å…¨ä½“ã®é–“éš”ãƒã‚§ãƒƒã‚¯
    let ok=true;
    for(let i=0;i<choices.length;i++){
      for(let j=i+1;j<choices.length;j++){
        if(Math.abs(choices[i]-choices[j])<minDiff){
          ok=false; break;
        }
      }
      if(!ok) break;
    }
    if(ok) return choices.sort((a,b)=>a-b);
    attempts++;
  }
  // fallbackï¼ˆ500å›è¶…ãˆãŸã‚‰å®‰å…¨ã«ãƒ©ãƒ³ãƒ€ãƒ ã§è¿”ã™ï¼‰
  return [-0.9,-0.6,-0.3,0.3,0.6,0.9];
}

function updateScoreDisplay(){
  document.getElementById("score").textContent=
    `ãƒ¬ãƒ™ãƒ«: ${level}  åˆè¨ˆæ­£è§£: ${totalCorrect}  é–“é•ã„: ${wrongCount}/3`;
}

function setRadioDisabled(disabled){
  document.querySelectorAll('input[name="rchoice"]').forEach(i=>i.disabled=disabled);
}

function newQuestion(){
  answered=false;
  document.getElementById("result").textContent="";
  level=Math.floor(totalCorrect/5)+1;
  trueR=to2((Math.random()*2-1));
  points=generateData(trueR,100,level);
  drawScatter(points);
  const choices=createChoices(trueR);
  const container=document.getElementById("choices");
  container.innerHTML="";
  choices.forEach((c)=>{
    const label=document.createElement("label");
    label.innerHTML=`<input type="radio" name="rchoice" value="${c}"> ${c.toFixed(2)}`;
    container.appendChild(label);
  });
  setRadioDisabled(false);
  updateScoreDisplay();
}

function checkAnswer(){
  if(answered)return;
  const selected=document.querySelector('input[name="rchoice"]:checked');
  if(!selected){alert("é¸æŠè‚¢ã‚’é¸ã‚“ã§ãã ã•ã„ï¼");return;}
  answered=true;
  const val=parseFloat(selected.value);
  if(Math.abs(val-trueR)<0.001){
    totalCorrect++;
    document.getElementById("result").textContent=`ğŸ¯ æ­£è§£ï¼ å®Ÿéš›ã®ç›¸é–¢ä¿‚æ•°ã¯ ${trueR.toFixed(2)}`;
  }else{
    wrongCount++;
    if(wrongCount>=3){
      document.getElementById("result").innerHTML=`ğŸ’€ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼!<br>
      æ­£è§£ã¯ <strong>${trueR.toFixed(2)}</strong><br>
      <span style="color:red;font-size:1.5rem;">æœ€çµ‚ã‚¹ã‚³ã‚¢: ${totalCorrect}</span>`;
    }else{
      document.getElementById("result").textContent=`âŒ æ®‹å¿µï¼ æ­£è§£ã¯ ${trueR.toFixed(2)} ã§ã—ãŸã€‚`;
    }
  }
  setRadioDisabled(true);
  updateScoreDisplay();
}

function nextQuestion(){
  if(wrongCount>=3){totalCorrect=0;wrongCount=0;}
  newQuestion();
}

document.getElementById("checkBtn").addEventListener("click",checkAnswer);
document.getElementById("nextBtn").addEventListener("click",nextQuestion);
window.addEventListener("resize",()=>drawScatter(points));
newQuestion();
</script>
</body>
</html>
